<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­¸å¿«æ¨‚å­¸ - Anki å…’ç«¥ç‰ˆ</title>
    <!-- å¼•å…¥å¯æ„›çš„åœ“é«”å­—å‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #FFB347; /* æº«æš–çš„æ©˜é»ƒè‰² */
            --secondary-color: #77DD77; /* æŸ”å’Œçš„ç¶ è‰² */
            --accent-color: #AEC6CF; /* å¯¶å¯¶è— */
            --wrong-color: #FF6961; /* æŸ”å’Œçš„ç´…è‰² */
            --text-color: #444;
            --bg-color: #FEF9E7; /* ç±³é»ƒè‰²è­·çœ¼èƒŒæ™¯ */
            --card-bg: #FFFFFF;
        }

        * {
            box-sizing: border-box;
            user-select: none; /* é˜²æ­¢å°å­©é•·æŒ‰é¸å–æ–‡å­— */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
        }

        /* é€šç”¨å®¹å™¨ */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        /* éš±è—é é¢ */
        .page {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .page.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-height: 70vh;
            overflow-y: auto;
            text-align: center;
            border: 4px solid var(--accent-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #333;
        }

        .hint-text {
            font-size: 1.5rem;
            color: #666;
            margin-bottom: 20px;
        }

        .answer-area {
            display: none; /* é è¨­éš±è—ç­”æ¡ˆ */
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px dashed #ddd;
            width: 100%;
        }

        .explanation {
            font-size: 1.4rem;
            color: #2c3e50;
            background-color: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            border: none;
            border-radius: 50px;
            padding: 15px 40px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            margin: 10px;
            font-family: inherit;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--secondary-color); color: white; }
        .btn-danger { background-color: var(--wrong-color); color: white; }
        .btn-neutral { background-color: var(--accent-color); color: white; }

        /* åº•éƒ¨æ§åˆ¶åˆ— */
        .controls {
            display: flex;
            gap: 15px;
            width: 100%;
            justify-content: center;
        }

        /* æ¨™é¡Œèˆ‡è£é£¾ */
        h1 {
            font-size: 2.5rem;
            color: var(--primary-color);
            text-shadow: 2px 2px 0px #fff;
            margin-bottom: 30px;
        }

        .mascot {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        /* æ•¸æ“šèˆ‡è¨­ç½®å€ */
        .stats-bar {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 1rem;
            color: #888;
        }
        
        .reset-btn {
            position: absolute;
            bottom: 10px;
            right: 20px;
            font-size: 0.8rem;
            background: none;
            border: none;
            color: #bbb;
            text-decoration: underline;
            cursor: pointer;
        }

        /* å¹³æ¿ç›´å¼å„ªåŒ– */
        @media (orientation: portrait) {
            .question-text { font-size: 4rem; }
            .btn { width: 100%; margin: 5px 0; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- ä¸»é¸å–®é é¢ -->
    <div id="home-page" class="page active">
        <div class="container">
            <div class="mascot">ğŸ¦</div>
            <h1>æ•¸å­¸æŒ‘æˆ°æ™‚é–“ï¼</h1>
            <p style="font-size: 1.5rem; color: #666; margin-bottom: 40px;">
                ä»Šå¤©æœ‰ <span id="due-count" style="color: var(--wrong-color); font-weight: bold;">0</span> é¡Œéœ€è¦è¤‡ç¿’å–”
            </p>
            <button class="btn btn-primary" onclick="startSession()">é–‹å§‹ç·´ç¿’</button>
            <button class="btn btn-neutral" onclick="clearDataConfirm()" style="margin-top:20px; font-size: 1rem; padding: 10px 20px; opacity: 0.7;">å®¶é•·è¨­å®šï¼šé‡ç½®é€²åº¦</button>
        </div>
    </div>

    <!-- å­¸ç¿’é é¢ -->
    <div id="study-page" class="page">
        <div class="container">
            <div class="stats-bar">
                å‰©é¤˜é¡Œç›®: <span id="remaining-count">0</span>
            </div>

            <!-- å¡ç‰‡å€åŸŸ -->
            <div class="card">
                <div id="card-content">
                    <!-- é¡Œç›®å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                </div>

                <div id="answer-section" class="answer-area">
                    <div id="answer-content">
                        <!-- ç­”æ¡ˆå°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>
                    <div class="explanation" id="explanation-content">
                        <!-- æ•™å­¸èªªæ˜ -->
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰éˆ•å€ -->
            <div class="controls" id="show-answer-btn-area">
                <button class="btn btn-primary" onclick="showAnswer()">çœ‹ç­”æ¡ˆ ğŸ‘€</button>
            </div>

            <!-- è©•åˆ†æŒ‰éˆ•å€ (é¡¯ç¤ºç­”æ¡ˆå¾Œå‡ºç¾) -->
            <div class="controls" id="rating-btns-area" style="display: none;">
                <button class="btn btn-danger" onclick="rateCard(1)">
                    å†ç·´ç¿’ ğŸ˜Ÿ<br><span style="font-size:0.8rem">1åˆ†é˜å¾Œ</span>
                </button>
                <button class="btn btn-primary" onclick="rateCard(3)">
                    é‚„å¯ä»¥ ğŸ¤”<br><span style="font-size:0.8rem">æ˜å¤©</span>
                </button>
                <button class="btn btn-success" onclick="rateCard(5)">
                    å¤ªç°¡å–®äº† ğŸ¤©<br><span style="font-size:0.8rem">4å¤©å¾Œ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- å®Œæˆé é¢ -->
    <div id="finish-page" class="page">
        <div class="container">
            <div class="mascot">ğŸ‰</div>
            <h1>å¤ªæ£’äº†ï¼</h1>
            <p style="font-size: 1.5rem;">ä»Šå¤©çš„è¤‡ç¿’éƒ½å®Œæˆäº†ï¼</p>
            <button class="btn btn-primary" onclick="goHome()">å›é¦–é </button>
        </div>
    </div>

    <script>
        // --- 1. é¡Œç›®è³‡æ–™åº« (æ‚¨å¯ä»¥ä¹‹å¾Œæ…¢æ…¢å¢åŠ é€™è£¡çš„å…§å®¹) ---
        // id: å”¯ä¸€è­˜åˆ¥ç¢¼
        // q: é¡Œç›® (æ”¯æ´ HTML)
        // a: ç­”æ¡ˆ
        // exp: æ•™å­¸/è§£é‡‹
        const defaultQuestions = [
            {
                id: 1,
                q: "2 + 3 = ?",
                a: "5",
                exp: "è©¦è‘—æ•¸æ•¸çœ‹ï¼šğŸğŸ åŠ ä¸Š ğŸğŸğŸ ç­‰æ–¼ 5 é¡†è˜‹æœï¼"
            },
            {
                id: 2,
                q: "10 - 4 = ?",
                a: "6",
                exp: "ä½ æœ‰ 10 é¡†ç³–æœï¼Œåƒæ‰äº† 4 é¡†ï¼Œå‰©ä¸‹ 6 é¡†ã€‚"
            },
            {
                id: 3,
                q: "5 x 2 = ?",
                a: "10",
                exp: "é€™å°±åƒæ˜¯æœ‰ 2 å †ç©æœ¨ï¼Œæ¯å †æœ‰ 5 å€‹ã€‚<br>5 + 5 = 10ã€‚"
            },
            {
                id: 4,
                q: "å“ªä¸€å€‹æ•¸å­—æ¯”è¼ƒå¤§ï¼Ÿ<br> 8 é‚„æ˜¯ 12",
                a: "12",
                exp: "12 æ˜¯äºŒä½æ•¸ï¼Œ8 æ˜¯ä¸€ä½æ•¸ã€‚<br>12 æ¯” 8 å¤šäº† 4ã€‚"
            },
            {
                id: 5,
                q: "é˜é¢ä¸Šçš„é•·é‡æŒ‡è‘— 12ï¼ŒçŸ­é‡æŒ‡è‘— 3ã€‚<br>ç¾åœ¨æ˜¯å¹¾é»ï¼Ÿ",
                a: "3 é»é˜",
                exp: "çŸ­é‡æ˜¯æ™‚é‡ï¼Œé•·é‡æ˜¯åˆ†é‡ã€‚<br>åˆ†é‡åœ¨ 12 ä»£è¡¨æ•´é»ã€‚"
            }
        ];

        // --- 2. æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹ ---
        let cards = [];
        let sessionQueue = []; // ç•¶å‰å­¸ç¿’éšŠåˆ—
        let currentCard = null;

        // --- 3. æ ¸å¿ƒé‚è¼¯ (Local Storage & Anki ç°¡æ˜“æ¼”ç®—æ³•) ---

        // åˆå§‹åŒ–
        function initApp() {
            loadData();
            updateHomeStats();
        }

        // è®€å–è³‡æ–™
        function loadData() {
            const storedData = localStorage.getItem('ankiMathKids_v1');
            if (storedData) {
                cards = JSON.parse(storedData);
                // æª¢æŸ¥æ˜¯å¦æœ‰æ–°é¡Œç›®åŠ å…¥ (ç°¡å–®çš„ id æ¯”å°)
                defaultQuestions.forEach(q => {
                    if (!cards.find(c => c.id === q.id)) {
                        // åˆå§‹åŒ–æ–°å¡ç‰‡
                        cards.push({
                            ...q,
                            interval: 0,
                            reps: 0,
                            ef: 2.5, // è¼•é¬†åº¦ä¿‚æ•¸ (Ease Factor)
                            nextReview: 0 // æ™‚é–“æˆ³
                        });
                    }
                });
            } else {
                // ç¬¬ä¸€æ¬¡ä½¿ç”¨
                cards = defaultQuestions.map(q => ({
                    ...q,
                    interval: 0,
                    reps: 0,
                    ef: 2.5,
                    nextReview: 0
                }));
            }
            saveData();
        }

        // å­˜æª”
        function saveData() {
            localStorage.setItem('ankiMathKids_v1', JSON.stringify(cards));
        }

        // æ¸…é™¤è³‡æ–™
        function clearDataConfirm() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å­¸ç¿’é€²åº¦å—ï¼Ÿå°å­©çš„è¤‡ç¿’ç´€éŒ„æœƒæ­¸é›¶å–”ï¼")) {
                localStorage.removeItem('ankiMathKids_v1');
                location.reload();
            }
        }

        // æ›´æ–°é¦–é æ•¸å­—
        function updateHomeStats() {
            const now = Date.now();
            const due = cards.filter(c => c.nextReview <= now).length;
            document.getElementById('due-count').innerText = due;
        }

        // --- 4. å­¸ç¿’æµç¨‹æ§åˆ¶ ---

        function startSession() {
            const now = Date.now();
            // æ‰¾å‡ºæ‰€æœ‰åˆ°æœŸæˆ–é‚„æ²’å­¸éçš„å¡ç‰‡
            sessionQueue = cards.filter(c => c.nextReview <= now);
            
            if (sessionQueue.length === 0) {
                // å¦‚æœæ²’æœ‰åˆ°æœŸçš„ï¼Œå¯ä»¥ç·´ç¿’ä¸€äº›æœªä¾†çš„ï¼Œæˆ–æ˜¯éš¨æ©Ÿé¸å¹¾é¡Œè¤‡ç¿’ (é€™è£¡æˆ‘å€‘å…ˆç°¡å–®è™•ç†ï¼šç›´æ¥é¡¯ç¤ºå®Œæˆ)
                // ç‚ºäº†è®“å±•ç¤ºæœ‰è¶£ï¼Œå¦‚æœå…¨éƒ¨åšå®Œäº†ï¼Œå°±æŠ“æœ€æ—©è¤‡ç¿’çš„é‚£å¹¾é¡Œé€²ä¾†
                 alert("ç›®å‰æ²’æœ‰åˆ°æœŸçš„é¡Œç›®ï¼Œä½†æˆ‘å€‘é‚„æ˜¯ä¾†ç·´ç¿’ä¸€ä¸‹å§ï¼");
                 sessionQueue = [...cards].sort((a,b) => a.nextReview - b.nextReview).slice(0, 5);
            }

            if (sessionQueue.length > 0) {
                showPage('study-page');
                loadNextCard();
            } else {
                showPage('finish-page');
            }
        }

        function loadNextCard() {
            if (sessionQueue.length === 0) {
                showPage('finish-page');
                updateHomeStats();
                return;
            }

            currentCard = sessionQueue[0];
            document.getElementById('remaining-count').innerText = sessionQueue.length;
            
            // æ¸²æŸ“å¡ç‰‡å…§å®¹
            document.getElementById('card-content').innerHTML = `<div class="question-text">${currentCard.q}</div>`;
            document.getElementById('answer-content').innerText = currentCard.a;
            document.getElementById('explanation-content').innerHTML = currentCard.exp || "å¤ªæ£’äº†ï¼";

            // é‡ç½® UI ç‹€æ…‹
            document.getElementById('answer-section').style.display = 'none';
            document.getElementById('show-answer-btn-area').style.display = 'flex';
            document.getElementById('rating-btns-area').style.display = 'none';
        }

        function showAnswer() {
            document.getElementById('answer-section').style.display = 'block';
            document.getElementById('show-answer-btn-area').style.display = 'none';
            document.getElementById('rating-btns-area').style.display = 'flex';
            
            // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨ï¼Œç¢ºä¿æŒ‰éˆ•å¯è¦‹
            setTimeout(() => {
                 document.querySelector('.card').scrollTop = document.querySelector('.card').scrollHeight;
            }, 100);
        }

        // æ ¸å¿ƒæ¼”ç®—æ³• (SM-2 ç°¡åŒ–ç‰ˆ)
        // quality: 1 (é‡ä¾†/ä¸æœƒ), 3 (é‚„å¯ä»¥), 5 (ç°¡å–®)
        function rateCard(quality) {
            const now = Date.now();
            const dayMillis = 24 * 60 * 60 * 1000;

            // åœ¨åŸå§‹è³‡æ–™é™£åˆ—ä¸­æ‰¾åˆ°é€™å¼µå¡ç‰‡
            let cardIndex = cards.findIndex(c => c.id === currentCard.id);
            let card = cards[cardIndex];

            if (quality < 3) {
                // ç­”éŒ¯äº†ï¼šé‡ç½®
                card.reps = 0;
                card.interval = 1;
                // è¨­å®šç‚º 1 åˆ†é˜å¾Œé‡è©¦ (é€™è£¡ç‚ºäº† Demo æ–¹ä¾¿ï¼Œè¨­ç‚º 0ï¼Œå¦‚æœéšŠåˆ—é‚„æœ‰é¡Œå°±æœƒæ’åœ¨å¾Œé¢)
                card.nextReview = now + 60000; 
                
                // æ—¢ç„¶ç­”éŒ¯äº†ï¼Œé€™é¡Œä¸ç§»å‡º sessionQueueï¼Œè€Œæ˜¯ç§»åˆ°éšŠåˆ—æœ€å¾Œé¢å†åšä¸€æ¬¡
                sessionQueue.shift(); // ç§»é™¤é–‹é ­
                sessionQueue.push(currentCard); // åŠ åˆ°æœ€å¾Œ
                
            } else {
                // ç­”å°äº†
                if (card.reps === 0) {
                    card.interval = 1;
                } else if (card.reps === 1) {
                    card.interval = 6;
                } else {
                    card.interval = Math.round(card.interval * card.ef);
                }

                card.reps += 1;
                // èª¿æ•´è¼•é¬†åº¦ (EF)
                // ç°¡å–®ç®—æ³•ï¼šå¦‚æœè¦ºå¾—ç°¡å–®(5)ï¼ŒEF å¢åŠ ï¼›å¦‚æœè¦ºå¾—é›£(3)ï¼ŒEFç¨å¾®æ¸›å°‘
                if (quality === 5) card.ef = card.ef + 0.1;
                if (quality === 3) card.ef = Math.max(1.3, card.ef - 0.15);

                // è¨­å®šä¸‹æ¬¡è¤‡ç¿’æ™‚é–“ (å¤©æ•¸ * æ¯«ç§’)
                // æ³¨æ„ï¼šå¦‚æœæ˜¯"å¤ªç°¡å–®"ï¼Œæˆ‘å€‘åŠ ä¸€é»éš¨æ©Ÿæ€§é¿å…é¡Œç›®å †ç©
                card.nextReview = now + (card.interval * dayMillis);
                
                // ç§»å‡ºç•¶å‰å­¸ç¿’éšŠåˆ—
                sessionQueue.shift();
            }

            saveData(); // å­˜æª”
            loadNextCard(); // ä¸‹ä¸€é¡Œ
        }

        // --- 5. é é¢åˆ‡æ› ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function goHome() {
            updateHomeStats();
            showPage('home-page');
        }

        // å•Ÿå‹•
        initApp();

    </script>
</body>
</html>
